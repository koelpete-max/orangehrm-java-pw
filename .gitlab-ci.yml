image: mcr.microsoft.com/playwright/java:v1.56.0-jammy

stages:
  - test

services:
  - name: docker:dind
    alias: docker

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  MAVEN_CLI_OPTS: "-B"
  BASE_URL: "http://docker:8080"

ui_tests:
  stage: test
  script:
    # --- 1) Docker CLI + tools ---
    - apt-get update
    - apt-get install -y docker.io default-mysql-client curl
    - docker --version
    - docker info

    # --- 2) Login to GitLab registry so we can pull your custom images ---
    - echo "$CI_JOB_TOKEN" | docker login "$CI_REGISTRY" -u gitlab-ci-token --password-stdin

    # --- 3) Network, same as local ---
    - docker network create orange-net || echo "network exists"

    # --- 4) Start *seeded* DB container (YOUR IMAGE HERE) ---
    - |
      docker run -d --name orangehrm-db --network orange-net \
        -p 3306:3306 \
        registry.gitlab.com/koelpete-group/hrm-jv-pw/orangehrm-db-frozen:os57-v1

    # --- 5) Start OrangeHRM app container ---
    - |
      docker run -d --name orangehrm --network orange-net \
        -p 8080:80 \
        -e ORANGEHRM_DATABASE_HOST=orangehrm-db \
        -e ORANGEHRM_DATABASE_PORT_NUMBER=3306 \
        -e ORANGEHRM_DATABASE_NAME=orangehrm \
        -e ORANGEHRM_DATABASE_USER=orangeuser \
        -e ORANGEHRM_DATABASE_PASSWORD=orangepass \
        orangehrm/orangehrm:5.7

    # --- 6) Wait for DB (should already have all tables) ---
    - echo "Waiting for MariaDB (seeded)..."
    - |
      for i in $(seq 1 30); do
        if mysql -h docker -P 3306 -u orangeuser -porangepass -e "SHOW TABLES FROM orangehrm;" | grep -q "ohrm_"; then
          echo "✅ Seeded DB is up with OrangeHRM tables"
          break
        fi
        echo "DB not ready yet ($i/30)..."
        sleep 5
      done

    # --- 7) Wait for app ---
    - echo "Waiting for OrangeHRM..."
    - |
      for i in $(seq 1 30); do
        if curl -sSf http://docker:8080 > /dev/null; then
          echo "✅ OrangeHRM is up"
          break
        fi
        echo "App not ready yet ($i/30)..."
        sleep 5
      done

    # --- 8) Run tests (should see login screen, NOT installer) ---
    - echo "BASE_URL = $BASE_URL"
    - mvn $MAVEN_CLI_OPTS clean test -Dsurefire.suiteXmlFiles=testng.xml

  artifacts:
    when: always
    expire_in: 14 days
    reports:
      junit:
        - target/surefire-reports/*.xml
    paths:
      - target/surefire-reports/
      - test-output/
