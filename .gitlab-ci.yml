image: mcr.microsoft.com/playwright/java:v1.56.0-jammy

stages:
  - test

variables:
  MAVEN_CLI_OPTS: "-B"
  BASE_URL: "http://orangehrm"

services:
  - name: mariadb:11.3
    alias: orangehrm-db
    variables:
      MARIADB_ROOT_PASSWORD: rootpass
      MARIADB_DATABASE: orangehrm
      MARIADB_USER: orangeuser
      MARIADB_PASSWORD: orangepass

  - name: orangehrm/orangehrm:5.7
    alias: orangehrm
    variables:
      ORANGEHRM_DATABASE_HOST: orangehrm-db
      ORANGEHRM_DATABASE_PORT_NUMBER: "3306"
      ORANGEHRM_DATABASE_NAME: orangehrm
      ORANGEHRM_DATABASE_USER: orangeuser
      ORANGEHRM_DATABASE_PASSWORD: orangepass

ui_tests:
  stage: test
  before_script:
    - apt-get update
    - apt-get install -y mariadb-client netcat-openbsd curl
  script:
    - echo "PWD:" && pwd
    - echo "Repo content:" && ls

    - echo "Java version:" && java -version
    - echo "Maven version:" && mvn -v

    # ðŸ”Ž Debug networking first
    - echo "DNS for orangehrm-db:"
    - getent hosts orangehrm-db || echo "no DNS entry for orangehrm-db"

    - echo "Ping orangehrm-db:"
    - ping -c 2 orangehrm-db || echo "ping failed (can be normal if ping blocked)"

    - echo "Check TCP 3306 with nc:"
    - nc -vz orangehrm-db 3306 || echo "nc failed to reach 3306"

    # âœ… Robust MariaDB readiness check (force TCP!)
    - echo "Waiting for MariaDB at orangehrm-db:3306..."
    - |
      for i in $(seq 1 30); do
        if mysqladmin \
             --protocol=tcp \
             -horangehrm-db \
             -P3306 \
             -uroot -prootpass \
             ping >/dev/null 2>&1; then
          echo "MariaDB is up."
          break
        fi
        echo "MariaDB not ready yet ($i/30)..."
        sleep 2
      done

    - echo "Check DBs with mysql (root):"
    - mysql \
      --protocol=tcp \
      -horangehrm-db \
      -P3306 \
      -uroot -prootpass \
      -e "SHOW DATABASES;"

    - echo "Try login as app user:"
    - mysql \
      --protocol=tcp \
      -horangehrm-db \
      -P3306 \
      -uorangeuser -porangepass \
      -e "SHOW DATABASES;" || echo "orangeuser login failed"

    # Wait for OrangeHRM HTTP
    - echo "Waiting for OrangeHRM at $BASE_URL ..."
    - |
      for i in $(seq 1 40); do
        if curl -sSf "$BASE_URL" >/dev/null 2>&1; then
          echo "OrangeHRM is reachable."
          break
        fi
        echo "OrangeHRM not ready yet ($i/40)..."
        sleep 5
      done

    # Run tests
    - echo "Starting tests with Maven..."
    - mvn $MAVEN_CLI_OPTS test -Dsurefire.suiteXmlFiles=testng.xml

  artifacts:
    when: always
    expire_in: 14 days
    reports:
      junit:
        - target/surefire-reports/*.xml
    paths:
      - target/surefire-reports/
      - test-output/
      - test-results/