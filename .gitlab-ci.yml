image: mcr.microsoft.com/playwright/java:v1.56.0-jammy

stages:
  - test

variables:
  MAVEN_CLI_OPTS: "-B"
  BASE_URL: "http://orangehrm"

services:
  - name: mariadb:11.3
    alias: orangehrm-db
    variables:
      MARIADB_ROOT_PASSWORD: rootpass
      MARIADB_DATABASE: orangehrm
      MARIADB_USER: orangeuser
      MARIADB_PASSWORD: orangepass

  - name: orangehrm/orangehrm:5.7
    alias: orangehrm
    variables:
      ORANGEHRM_DATABASE_HOST: orangehrm-db
      ORANGEHRM_DATABASE_PORT_NUMBER: "3306"
      ORANGEHRM_DATABASE_NAME: orangehrm
      ORANGEHRM_DATABASE_USER: orangeuser
      ORANGEHRM_DATABASE_PASSWORD: orangepass

ui_tests:
  stage: test
  script:
    - echo "PWD:" && pwd
    - echo "Repo:" && ls

    - echo "Java version:" && java -version
    - echo "Maven version:" && mvn -v

    # üîß 1) DEBUG: ist mysql √ºberhaupt da?
    - echo "Before install: which mysql?"
    - which mysql || echo "mysql NOT found before install"

    # üîß 2) mysql + curl installieren
    - echo "Installing mysql client + curl..."
    - apt-get update -y
    - apt-get install -y default-mysql-client curl

    # üîß 3) DEBUG: jetzt sollte mysql da sein
    - echo "After install: which mysql?"
    - which mysql || echo "mysql STILL not found after install!"

    # üîç 4) DB-Check (non-fatal)
    - echo "Check DB connectivity (non-fatal)..."
    - |
      set +e
      mysql --protocol=tcp \
            -horangehrm-db \
            -P3306 \
            -uorangeuser -porangepass \
            -e "SHOW DATABASES;"
      echo "mysql exit code: $?"
      set -e

    # üîç 5) Welche Seite liefert OrangeHRM?
    - echo "Probe OrangeHRM homepage (headers + first lines)..."
    - |
      set +e
      curl -sS -D- "$BASE_URL" | head -n 40
      echo "curl exit code: $?"
      set -e

    # üîÅ 6) Tests
    - echo "Running Maven tests..."
    - mvn $MAVEN_CLI_OPTS test -Dsurefire.suiteXmlFiles=testng.xml

    - echo "Tree after mvn test:"
    - ls -R

  artifacts:
    when: always
    expire_in: 14 days
    reports:
      junit:
        - target/surefire-reports/*.xml
    paths:
      - target/surefire-reports/
      - test-output/