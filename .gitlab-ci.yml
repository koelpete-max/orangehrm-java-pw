image: mcr.microsoft.com/playwright/java:v1.56.0-jammy

stages:
  - test

variables:
  MAVEN_CLI_OPTS: "-B"
  BASE_URL: "http://orangehrm-app"  # host = service alias

services:
  # 1) Frozen DB from GitLab registry
  - name: registry.gitlab.com/koelpete-group/hrm-jv-pw/orangehrm-db-frozen:os57-final

    alias: orangehrm-db
    # if needed, you can pass env vars here, but for a seeded DB
    # usually the defaults inside the image are enough

  # 2) Official OrangeHRM 5.7 app, pointing to the DB
  - name: orangehrm/orangehrm:5.7
    alias: orangehrm-app
    variables:
      ORANGEHRM_DATABASE_HOST: orangehrm-db-frozen
      ORANGEHRM_DATABASE_PORT_NUMBER: "3306"
      ORANGEHRM_DATABASE_NAME: orangehrm
      ORANGEHRM_DATABASE_USER: orangeuser
      ORANGEHRM_DATABASE_PASSWORD: orangepass
      ORANGEHRM_ENCRYPTION: "no"     # if available / needed

ui_tests:
  stage: test
  script:
    - echo "PWD:" && pwd
    - echo "Repo:" && ls
    - echo "Java version:" && java -version
    - echo "Maven version:" && mvn -v

    # Optional: quick check that the app is reachable
    - echo "Waiting for OrangeHRM..."
    - |
      for i in $(seq 1 12); do
        if curl -sSf "$BASE_URL" >/dev/null 2>&1; then
          echo "OrangeHRM seems reachable (curl succeeded)."
          break
        fi
        echo "OrangeHRM not ready yet ($i/12)..."
        sleep 5
      done

    # Now run your TestNG suite
    - mkdir -p test-output test-results
    - echo "Java version:" && java -version
    - echo "Maven version:" && mvn -v
    - mvn $MAVEN_CLI_OPTS test -Dsurefire.suiteXmlFiles=testng.xml

    # For debugging:
    - echo "Tree after mvn test:" && ls -R

  artifacts:
    when: always
    expire_in: 14 days
    reports:
      junit:
        - target/surefire-reports/*.xml
    paths:
      - target/surefire-reports/
      - test-output/
      - test-results/

#image: mcr.microsoft.com/playwright/java:v1.56.0-jammy
#
#stages:
#  - test
#
#variables:
#  MAVEN_CLI_OPTS: "-B -q"
#  BASE_URL: "http://orangehrm-app"   # Alias aus services
#
#services:
#  - name: registry.gitlab.com/koelpete-group/hrm-jv-pw/orangehrm-db-seeded:os57-v1
#    alias: test-db        # muss zum Hostnamen in deiner Conf.php passen!
#  - name: registry.gitlab.com/koelpete-group/hrm-jv-pw/orangehrm-app-configured:os57-v1
#    alias: orangehrm-app
#
#ui_tests:
#  stage: test
#  script:
#    - echo "Java version:" && java -version
#    - echo "Maven version:" && mvn -v
#    - mvn $MAVEN_CLI_OPTS clean test -Dsurefire.suiteXmlFiles=testng.xml
#  artifacts:
#    when: always
#    expire_in: 14 days
#    reports:
#      junit:
#        - target/surefire-reports/*.xml
#    paths:
#      - target/surefire-reports/
#      - test-output/
#      - test-results/



#image: ubuntu:22.04
#
#stages:
#  - test
#
#variables:
#  MAVEN_CLI_OPTS: "-B -q"
#  BASE_URL: "http://orangehrm"
#  NO_ABSOLUTE_SCREENSHOT_PATH: "true"
#
#before_script:
#  - apt-get update
#  - apt-get install -y openjdk-21-jdk maven curl unzip default-mysql-client
#  - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
#  - apt-get install -y nodejs
#  - npx playwright install-deps
#  - npx playwright install
#
#cache:
#  key: "maven-cache"
#  paths:
#    - .m2/repository
#
#services:
#  - name: mariadb:11.3
#    alias: mariadb
#    variables:
#      MYSQL_ROOT_PASSWORD: rootpass
#      MYSQL_DATABASE: orangehrm
#      MYSQL_USER: orangeuser
#      MYSQL_PASSWORD: orangepass
#
#  - name: registry.gitlab.com/koelpete-group/hrm-jv-pw/orangehrm-app-configured:1.0
#    alias: orangehrm
#
#  - name: registry.gitlab.com/koelpete-group/hrm-jv-pw/orangehrm-app-configured:1.0
#    alias: orangehrm
#  - name: orangehrm/orangehrm:5.7
#    alias: orangehrm
#    variables:
#      MARIADB_HOST: mariadb
#      MARIADB_PORT: "3306"
#      MARIADB_USER: orangeuser
#      MARIADB_PASSWORD: orangepass
#      MARIADB_DATABASE: orangehrm
#      ORANGEHRM_PASSWORD: admin123
#
#ui_tests:
#  stage: test
#  script:
#    - echo "BASE_URL ($BASE_URL)"
#    - echo "Java version:" && java -version
#    - echo "Maven version:" && mvn -v
#
#    # ⏱ 1) Auf MariaDB warten
#    - echo "Warte auf MariaDB..."
#    - |
#      apt-get update && apt-get install -y mariadb-client
#      for i in $(seq 1 30); do
#        if mysqladmin ping -hmariadb -prootpass --silent; then
#          echo "MariaDB ist erreichbar."
#          break
#        fi
#        echo "MariaDB noch nicht bereit ($i/30)..."
#        sleep 5
#      done
#
#    # ⏱ 2) DB mit seed-out.sql befüllen
#    - echo "Importiere seed-out.sql in Datenbank orangehrm..."
#    - mysql -hmariadb -uorangeuser -porangepass orangehrm < docker/db/seed-out.sql
#
#    # ⏱ 3) Auf OrangeHRM-App warten
#    - echo "Warte auf OrangeHRM..."
#    - |
#      for i in $(seq 1 40); do
#        if curl -sSf "${BASE_URL}" >/dev/null 2>&1; then
#          echo "OrangeHRM ist erreichbar."
#          break
#        fi
#        echo "OrangeHRM noch nicht bereit ($i/40)..."
#        sleep 5
#      done
#
#    # ⏱ 4) Tests ausführen
#    - mvn $MAVEN_CLI_OPTS clean test -Dsurefire.suiteXmlFiles=testng.xml
#
#  artifacts:
#    when: always
#    expire_in: 14 days
#    reports:
#      junit:
#        - target/surefire-reports/*.xml
#    paths:
#      - target/surefire-reports/
#      - test-output/
